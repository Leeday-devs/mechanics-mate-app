# Car Mate - Technical Documentation

## Project Overview

Car Mate is an AI-powered automotive assistant that combines Claude AI with real-time forum search to provide verified, vehicle-specific automotive repair and maintenance advice.

## Architecture

### Frontend (Client-Side)
- **Technology**: Vanilla JavaScript, HTML5, CSS3
- **Design Approach**: Mobile-first responsive design
- **UI Theme**: Racing-inspired dark mode with red/black/yellow color scheme
- **Main Components**:
  - Vehicle selector (5 dropdowns: Year, Make, Model, Engine Type, Engine Size)
  - Chat interface with message history
  - Welcome screen with suggestion cards
  - Auto-resizing text input
- **Mobile Optimizations**:
  - Touch-friendly controls (min 44x44px touch targets)
  - Stacked layout on mobile, horizontal on tablet/desktop
  - 16px minimum font size to prevent iOS zoom
  - Dynamic viewport height (dvh) for mobile browsers
  - Safe area padding for notched devices
  - Momentum scrolling on iOS
  - Prevented pull-to-refresh behavior

### Backend (Server-Side)
- **Technology**: Node.js with Express
- **API Endpoint**: `/api/chat` (POST)
- **Main Features**:
  - Claude AI integration via Anthropic SDK
  - Real-time forum search via Google Custom Search API
  - Vehicle context extraction and injection
  - Conversation history management

## Key Files

### server.js
**Purpose**: Backend API server
**Key Functions**:
- `searchForums(vehicleInfo, userQuestion)`: Searches automotive forums for relevant discussions
  - Targets: Reddit r/MechanicAdvice, r/Cartalk, BobIsTheOilGuy, RepairPal
  - Returns top 5 results with title, snippet, and link
  - Gracefully handles missing API credentials
- `/api/chat` endpoint: Processes user messages and returns AI responses
  - Extracts vehicle info from message prefix: `[Vehicle: YYYY Make Model EngineSize EngineType]`
  - Calls `searchForums()` for real-time data
  - Injects forum results into Claude's system prompt
  - Maintains conversation history

**Model**: claude-3-5-sonnet-20250219
**Max Tokens**: 2048

**System Prompt Strategy**: Multi-step verification process
1. Analyze user question with vehicle context
2. Review forum discussions for real-world experiences
3. Search knowledge base for vehicle-specific info
4. Cross-reference TSBs, recalls, common issues
5. Verify answers against multiple sources
6. Cite sources from forum discussions
7. Provide verified answer with safety warnings

### script.js
**Purpose**: Frontend JavaScript controller
**Key Features**:
- Vehicle data management:
  - 27 car makes with corresponding models
  - Year range: 2000-current year
  - Dynamic model population based on make selection
- Message formatting with vehicle context injection
- Markdown-like text formatting (bold, italic, code blocks, lists)
- Auto-scrolling chat interface
- Conversation history tracking

**Vehicle Context Format**:
```javascript
fullMessage = `[Vehicle: ${year} ${make} ${model} ${size} ${engine}] ${message}`
```

### index.html
**Purpose**: Main application structure
**Key Elements**:
- Custom car logo SVG with yellow headlights
- Five-tier vehicle selector
- Chat message container with welcome screen
- Fixed input bar at bottom
- Loading indicator with animated typing dots

### style.css
**Purpose**: Racing-themed styling
**Design System**:
- Colors:
  - Primary: Red (#d32f2f, #c62828)
  - Accent: Yellow (#ffb300)
  - Background: Dark gray (#1a1a1a, #2b2b2b)
  - Text: Light gray (#e0e0e0)
- Gradients on top bar and suggestion cards
- Custom dropdown styling with yellow arrows
- Smooth animations and transitions
- Responsive layout

## Data Flow

1. **User Input**:
   ```
   User selects: 2020 Honda Civic, 2.0L, Gas/Petrol
   User types: "Why is my car making a knocking sound?"
   ```

2. **Frontend Processing**:
   ```javascript
   // Combines vehicle info + question
   fullMessage = "[Vehicle: 2020 Honda Civic 2.0L Gas/Petrol] Why is my car making a knocking sound?"

   // Sends to API
   fetch('/api/chat', {
     method: 'POST',
     body: JSON.stringify({
       message: fullMessage,
       conversationHistory: [...]
     })
   })
   ```

3. **Backend Processing**:
   ```javascript
   // Extract vehicle info
   vehicleInfo = "2020 Honda Civic 2.0L Gas/Petrol"
   cleanMessage = "Why is my car making a knocking sound?"

   // Search forums
   forumResults = searchForums(vehicleInfo, cleanMessage)
   // Returns: Top 5 forum discussions about Honda Civic knocking sounds

   // Build enhanced system prompt with forum context
   systemPrompt = `
   VEHICLE CONTEXT: 2020 Honda Civic 2.0L Gas/Petrol

   RECENT FORUM DISCUSSIONS:
   1. "2020 Honda Civic knocking noise - rod bearing issue"
   2. "Civic 2.0L engine knock after cold start - VTC actuator"
   ...

   YOUR PROCESS:
   1. Analyze the question
   2. Review forum discussions
   3. Cross-reference knowledge base
   ...
   `

   // Call Claude API
   response = claude.messages.create({
     model: 'claude-3-5-sonnet-20250219',
     system: systemPrompt,
     messages: conversationHistory + userMessage
   })
   ```

4. **AI Response**:
   - Claude analyzes forum discussions + vehicle specs
   - Provides vehicle-specific diagnosis
   - Cites forum sources
   - Includes safety warnings
   - Returns verified answer

5. **Frontend Display**:
   - Formats response with markdown
   - Displays in chat interface
   - Updates conversation history

## Environment Variables

### Required
- `ANTHROPIC_API_KEY`: Claude API key (from console.anthropic.com)

### Optional
- `GOOGLE_SEARCH_API_KEY`: Google Custom Search API key
- `SEARCH_ENGINE_ID`: Custom search engine ID
- `PORT`: Server port (default: 3000)

**Note**: App works without Google API credentials but won't have real-time forum search.

## API Integration

### Anthropic Claude API
- **Model**: claude-3-5-sonnet-20250219
- **Max Tokens**: 2048
- **System Prompt**: Dynamic, includes vehicle context and forum results
- **Message Format**: Standard conversational history array

### Google Custom Search API
- **Endpoint**: `https://www.googleapis.com/customsearch/v1`
- **Parameters**:
  - `key`: API key
  - `cx`: Search engine ID
  - `q`: Search query (vehicle info + question + site filters)
  - `num`: Number of results (5)
- **Timeout**: 5000ms
- **Error Handling**: Graceful fallback if API unavailable

## Vehicle Database

### Current Coverage
- **Makes**: 27 (Acura through Volkswagen)
- **Models**: 5-15 per make (dynamically populated)
- **Years**: 2000-current year
- **Engine Types**: Gas/Petrol, Diesel, Hybrid, Plug-in Hybrid, Electric
- **Engine Sizes**: 1.0L - 6.2L (15 options)

### Extensibility
To add more vehicles, update `carMakes` and `carModels` objects in `script.js`:

```javascript
const carMakes = ['Acura', 'Audi', ...];

const carModels = {
  'Acura': ['ILX', 'TLX', 'RDX', 'MDX', 'NSX'],
  'NewMake': ['Model1', 'Model2', ...]
};
```

## UI Components

### Welcome Screen
- Displayed on initial load
- Contains 4 suggestion cards with common questions
- Hidden after first message sent
- Can be restored via "Clear conversation" button

### Vehicle Selector
- 5 cascading dropdowns
- Make selection triggers model population
- Optional fields (work without selection)
- Values sent with every message

### Chat Interface
- Auto-scrolling message container
- User messages: Right-aligned, blue background
- Assistant messages: Left-aligned, gray background
- Error messages: Red background
- Loading indicator: Animated typing dots

### Input Area
- Auto-resizing textarea (max 150px height)
- Send button (enabled when text present)
- Enter to send, Shift+Enter for new line
- Hint text at bottom

## Styling System

### Mobile-First CSS Architecture

The entire CSS is written with a mobile-first approach:

1. **Base Styles (Mobile)**:
   - Default styles target mobile devices (320px+)
   - Stacked layouts, single columns
   - Touch-optimized spacing and sizing
   - 16px minimum font size (prevents iOS zoom)
   - Touch targets minimum 44x44px (Apple HIG standard)

2. **Progressive Enhancement**:
   - `@media (min-width: 640px)` - Tablet optimizations
   - `@media (min-width: 1024px)` - Desktop enhancements
   - `@media (min-width: 1440px)` - Large screen adjustments

3. **Mobile-Specific Features**:
   ```css
   /* Dynamic viewport height for mobile browsers */
   height: 100dvh;

   /* Prevent pull-to-refresh */
   overscroll-behavior: none;

   /* iOS momentum scrolling */
   -webkit-overflow-scrolling: touch;

   /* Safe area for notched devices */
   padding-bottom: calc(1rem + env(safe-area-inset-bottom));

   /* Prevent text size adjustment */
   -webkit-text-size-adjust: 100%;

   /* Better touch feedback */
   touch-action: manipulation;

   /* Remove tap highlight */
   -webkit-tap-highlight-color: transparent;
   ```

4. **Responsive Breakpoints**:
   - Mobile: 0-639px (base styles)
   - Tablet: 640px-1023px
   - Desktop: 1024px-1439px
   - Large Desktop: 1440px+

### Color Palette
```css
--primary-red: #d32f2f;
--dark-red: #c62828;
--accent-yellow: #ffb300;
--bg-dark: #1a1a1a;
--bg-medium: #2b2b2b;
--bg-light: #3a3a3a;
--text-light: #e0e0e0;
--text-dim: #999;
```

### Gradients
- Top bar: Red linear gradient (135deg)
- Suggestion cards: Dark gray linear gradient (135deg)
- Welcome icon: Purple to blue gradient

### Typography
- Font family: Inter (Google Fonts)
- Weights: 300, 400, 500, 600, 700
- Mobile base size: 16px (inputs/selects)
- Desktop base size: 0.95rem (inputs/selects)

## Development Guidelines

### Adding New Features
1. Update frontend UI in `index.html`
2. Add styling in `style.css`
3. Implement logic in `script.js`
4. Update backend endpoint in `server.js` if needed
5. Update system prompt if AI behavior needs to change

### Modifying AI Behavior
Edit the `systemPrompt` variable in `server.js`:
- Add new capabilities to "YOUR CAPABILITIES" section
- Add new instructions to "YOUR PROCESS" section
- Add new safety rules to "IMPORTANT SAFETY RULES" section

### Adding Forum Sources
Update the search query in `searchForums()`:
```javascript
const searchQuery = `${vehicleInfo} ${userQuestion}
  site:reddit.com/r/MechanicAdvice OR
  site:reddit.com/r/Cartalk OR
  site:bobistheoilguy.com OR
  site:repairpal.com OR
  site:newforumsite.com`;  // Add new source
```

## Testing

### Manual Testing Checklist

**Desktop Testing**:
- [ ] Server starts without errors
- [ ] Frontend loads at http://localhost:3000
- [ ] Vehicle selector dropdowns populate correctly
- [ ] Model dropdown updates when make changes
- [ ] Messages send and receive successfully
- [ ] Vehicle context appears in AI responses
- [ ] Forum search works (if API configured)
- [ ] Conversation history persists during session
- [ ] Clear chat resets interface
- [ ] Error messages display properly

**Mobile Testing**:
- [ ] Test on actual mobile device (not just browser dev tools)
- [ ] Touch targets are easy to tap (44x44px minimum)
- [ ] No horizontal scrolling occurs
- [ ] Input fields don't cause zoom (16px+ font size)
- [ ] Keyboard doesn't cover input area
- [ ] Car selector dropdowns stack vertically on mobile
- [ ] Suggestion cards stack vertically on mobile
- [ ] Messages are readable (90% max-width on mobile)
- [ ] Scrolling feels smooth and natural
- [ ] Fixed input bar stays at bottom
- [ ] Safe area padding works on notched devices (iPhone X+)
- [ ] Works in both portrait and landscape orientations
- [ ] Pull-to-refresh is disabled
- [ ] Add to home screen functionality works

**Browser Testing**:
- [ ] iOS Safari (primary mobile browser)
- [ ] Chrome Mobile (Android)
- [ ] Firefox Mobile
- [ ] Desktop Chrome
- [ ] Desktop Firefox
- [ ] Desktop Safari

### Common Issues

**"Credit balance too low"**
- Cause: Insufficient Anthropic API credits
- Solution: Add credits at console.anthropic.com

**"Forum search not working"**
- Cause: Missing Google API credentials
- Solution: Add `GOOGLE_SEARCH_API_KEY` and `SEARCH_ENGINE_ID` to `.env`
- Note: App still works without forum search

**"Server connection error"**
- Cause: Server not running
- Solution: Run `npm start` in project directory

**"Model dropdown empty"**
- Cause: Make not in `carModels` object
- Solution: Add make and models to `script.js`

## Performance Considerations

### Frontend
- Minimal JavaScript libraries (vanilla JS)
- CSS animations use transform/opacity (GPU-accelerated)
- SVG icons (vector, small file size)
- Auto-resize textarea prevents layout shifts

### Backend
- Forum search timeout: 5000ms (prevents hanging)
- Max tokens limited to 2048 (faster responses)
- Graceful degradation if forum search fails
- Single-page app (no page reloads)

## Security Notes

### API Keys
- Never commit `.env` file to version control
- `.env` is in `.gitignore`
- Use `.env.example` as template

### CORS
- Currently allows all origins (development)
- Restrict in production:
  ```javascript
  app.use(cors({
    origin: 'https://yourdomain.com'
  }));
  ```

### Input Validation
- Backend validates message field existence
- Frontend sanitizes user input before display
- Markdown formatting prevents XSS (no raw HTML)

## Deployment Considerations

### Production Checklist
- [ ] Add credits to Anthropic API account
- [ ] Configure Google Custom Search API (optional)
- [ ] Set `PORT` environment variable
- [ ] Configure CORS for specific domain
- [ ] Use HTTPS for secure API communication
- [ ] Add rate limiting to API endpoint
- [ ] Set up error logging service
- [ ] Configure process manager (PM2)
- [ ] Set up reverse proxy (Nginx)

### Environment Variables for Production
```bash
ANTHROPIC_API_KEY=sk-ant-...
GOOGLE_SEARCH_API_KEY=AIza...
SEARCH_ENGINE_ID=...
PORT=3000
NODE_ENV=production
```

## Maintenance

### Regular Updates
- Check for Anthropic SDK updates: `npm update @anthropic-ai/sdk`
- Monitor Claude API changelog for model updates
- Update vehicle database with new makes/models
- Review and update forum sources list

### Monitoring
- Track API usage at console.anthropic.com
- Monitor Google API quota usage
- Log error rates and types
- Track response times

## Future Enhancement Ideas

1. **Database Integration**: Store conversation history in MongoDB/PostgreSQL
2. **User Accounts**: Allow users to save vehicles and chat history
3. **Image Upload**: Let users upload photos of issues
4. **Voice Input**: Add speech-to-text for questions
5. **Parts Integration**: Link to parts suppliers with pricing
6. **Maintenance Calendar**: Track service history and reminders
7. **Diagnostic Codes**: Database of OBD-II codes with explanations
8. **Multi-language**: Support for Spanish, French, German
9. **Mobile App**: React Native or Flutter app
10. **PDF Export**: Generate repair guide PDFs from conversations
